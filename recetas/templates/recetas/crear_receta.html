{% extends 'recetas/base.html' %}
{% load static %}
{% block title %}Crear receta{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-10">
            <div class="card shadow-lg p-4 p-md-5 border-0 bg-light animate-fadeInUp">
                <h2 class="text-center text-gold fw-bold mb-3">Crear nueva receta</h2>
                <p class="text-center">¡Comparte tu deliciosa receta con nosotros!</p>

                <form method="POST" enctype="multipart/form-data" id="recetaForm">
                    {% csrf_token %}

                    <!-- Título -->
                    <div class="mb-3">
                        <label class="fw-bold">Título de la receta*</label>
                        <input type="text" name="titulo" class="form-control"
                            placeholder="Ej: Paella valenciana tradicional..." required>
                    </div>

                    <!-- Descripción -->
                    <div class="mb-3">
                        <label class="fw-bold">Descripción*</label>
                        <textarea name="descripcion" rows="4" class="form-control" required
                            placeholder="Describe tu receta de manera atractiva..."></textarea>
                    </div>

                    <!-- Imagen principal -->
                    <div class="mb-4">
                        <label class="fw-bold">Imagen principal*</label>
                        <input type="file" id="imagen_principal" name="imagen" accept="image/*" class="form-control"
                            required>
                        <div id="preview_principal" class="preview mt-2"></div>
                    </div>

                    <!-- Más fotos -->
                    <div class="mb-4">
                        <label class="fw-bold">Más fotos (Opcional)</label>
                        <input type="file" id="mas_fotos" name="fotos_extra" accept="image/*" multiple
                            class="form-control">
                        <div id="preview_fotos" class="preview d-flex gap-2 flex-wrap mt-2"></div>
                    </div>

                    <!-- Categorías y Alergias -->
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="fw-bold">Categorías*</label>
                            <div id="categorias" class="tag-container">
                                <span class="tag" data-value="Desayunos">Desayunos</span>
                                <span class="tag" data-value="Almuerzos">Almuerzos</span>
                                <span class="tag" data-value="Cenas">Cenas</span>
                                <span class="tag" data-value="Postres">Postres</span>
                                <span class="tag" data-value="Bebidas">Bebidas</span>
                                <span class="tag" data-value="Vegetariano">Vegetariano</span>
                                <span class="tag" data-value="Vegano">Vegano</span>
                            </div>
                            <input type="hidden" name="categorias" id="categorias_input" required>
                            <div id="categoriasError" class="invalid-feedback" style="display:none;">
                                Selecciona al menos una categoría.
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="fw-bold">Alergias alimentarias (Opcional)</label>
                            <div id="alergias" class="tag-container">
                                <span class="tag" data-value="Leche">Leche</span>
                                <span class="tag" data-value="Huevo">Huevo</span>
                                <span class="tag" data-value="Maní">Maní</span>
                                <span class="tag" data-value="Frutos secos">Frutos secos</span>
                                <span class="tag" data-value="Soja">Soja</span>
                                <span class="tag" data-value="Gluten">Gluten</span>
                                <span class="tag" data-value="Pescado">Pescado</span>
                                <span class="tag" data-value="Marisco">Marisco</span>
                            </div>
                            <input type="hidden" name="alergias" id="alergias_input">
                        </div>
                    </div>

                    <!-- Dificultad / Tiempo / Porciones -->
                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <label class="fw-bold">Dificultad*</label>
                            <select class="form-select" name="dificultad" required>
                                <option value="">Seleccione una dificultad</option>
                                <option value="Fácil">Fácil</option>
                                <option value="Intermedio">Intermedio</option>
                                <option value="Difícil">Difícil</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="fw-bold">Tiempo (min)*</label>
                            <input type="number" min="1" name="tiempo" class="form-control" placeholder="Ej: 45"
                                required>
                        </div>
                        <div class="col-md-4">
                            <label class="fw-bold">Porciones*</label>
                            <input type="number" min="1" name="porciones" class="form-control" placeholder="Ej: 4"
                                required>
                        </div>
                    </div>

                    <!-- Ingredientes -->
                    <div class="mb-3">
                        <label class="fw-bold d-block mb-2">Ingredientes*</label>
                        <div id="ingredientes-list"></div>
                        <button type="button" class="btn btn-gold mt-2" id="btnAddIng">Agregar ingrediente</button>
                    </div>

                    <!-- Instrucciones -->
                    <div class="mb-3">
                        <label class="fw-bold d-block mb-2">Instrucciones*</label>
                        <div id="instrucciones-list"></div>
                        <button type="button" class="btn btn-gold mt-2" id="btnAddPaso">Agregar paso</button>
                    </div>

                    <!-- Botón publicar -->
                    <div class="text-center">
                        <button type="submit" class="btn btn-gold px-5">Publicar receta</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function createPreviewImg(file, container) {
        const wrapper = document.createElement('div');
        wrapper.className = "preview-wrapper";
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        img.className = "preview-img";
        const btn = document.createElement('button');
        btn.type = "button";
        btn.className = "remove-img";
        btn.innerHTML = "&times;";
        btn.onclick = () => wrapper.remove();
        wrapper.appendChild(img);
        wrapper.appendChild(btn);
        container.appendChild(wrapper);
    }

    // Imagen principal
    document.getElementById('imagen_principal').addEventListener('change', e => {
        const preview = document.getElementById('preview_principal');
        preview.innerHTML = '';
        const file = e.target.files[0];
        if (file) createPreviewImg(file, preview);
    });

    // Más fotos
    document.getElementById('mas_fotos').addEventListener('change', e => {
        const preview = document.getElementById('preview_fotos');
        preview.innerHTML = '';
        [...e.target.files].forEach(file => createPreviewImg(file, preview));
    });

    // --- Tags seleccionables ---
    function setupTags(containerId, inputId) {
        const container = document.getElementById(containerId);
        const input = document.getElementById(inputId);
        container.addEventListener('click', e => {
            if (e.target.classList.contains('tag')) {
                e.target.classList.toggle('selected');
                const values = [...container.querySelectorAll('.tag.selected')].map(tag => tag.dataset.value);
                input.value = values.join(',');
            }
        });
    }
    setupTags('categorias', 'categorias_input');
    setupTags('alergias', 'alergias_input');

    // --- Ingredientes ---
    function ingredienteRow(num) {
        return `<div class="ingredient-row d-flex align-items-center gap-2 mb-2">
    <span class="badge badge-gold ing-badge">${num}</span>
    <input type="text" name="ingredientes[nombre][]" class="form-control" placeholder="Ingrediente" required>
    <input type="number" name="ingredientes[cantidad][]" class="form-control" placeholder="Cant." min="0" step="any" required>
    <select name="ingredientes[unidad][]" class="form-select">
        <option>g</option><option>kg</option><option>ml</option><option>l</option>
        <option>taza</option><option>cdita</option><option>cda</option>
    </select>
    <button type="button" class="btn btn-danger btn-icon remove-ingredient">&times;</button>
    </div>`;
    }
    function renumerarIngredientes() {
        document.querySelectorAll('#ingredientes-list .ing-badge')
            .forEach((badge, i) => badge.textContent = i + 1);
    }

    // --- Instrucciones ---
    function pasoRow(num) {
        return `<div class="instruccion-row d-flex align-items-center gap-2 mb-2">
    <span class="badge badge-gold paso-badge">Paso ${num}</span>
    <input type="text" name="instrucciones[]" class="form-control" placeholder="Describe el paso..." required>
    <button type="button" class="btn btn-danger btn-icon remove-step">&times;</button>
    </div>`;
    }
    function renumerarPasos() {
        document.querySelectorAll('#instrucciones-list .paso-badge')
            .forEach((badge, i) => badge.textContent = `Paso ${i + 1}`);
    }

    // --- Inicialización ---
    (function init() {
        const ingList = document.getElementById('ingredientes-list');
        const pasosList = document.getElementById('instrucciones-list');

        ingList.insertAdjacentHTML('beforeend', ingredienteRow(1));
        pasosList.insertAdjacentHTML('beforeend', pasoRow(1));

        document.getElementById('btnAddIng').addEventListener('click', () => {
            ingList.insertAdjacentHTML('beforeend', ingredienteRow(ingList.children.length + 1));
        });
        document.getElementById('btnAddPaso').addEventListener('click', () => {
            pasosList.insertAdjacentHTML('beforeend', pasoRow(pasosList.children.length + 1));
        });

        ingList.addEventListener('click', e => {
            if (e.target.classList.contains('remove-ingredient')) {
                e.target.closest('.ingredient-row').remove(); renumerarIngredientes();
            }
        });
        pasosList.addEventListener('click', e => {
            if (e.target.classList.contains('remove-step')) {
                e.target.closest('.instruccion-row').remove(); renumerarPasos();
            }
        });
    })();

    // --- Validación del formulario ---
    document.getElementById("recetaForm").addEventListener("submit", function (e) {
        const categorias = document.getElementById("categorias_input").value.trim();
        const categoriasError = document.getElementById("categoriasError");

        if (!categorias) {
            e.preventDefault(); // evita enviar el form
            categoriasError.style.display = "block"; // muestra el mensaje en rojo
            document.getElementById("categorias").classList.add("is-invalid"); // opcional para borde rojo
        } else {
            categoriasError.style.display = "none"; // oculta si ya es válido
            document.getElementById("categorias").classList.remove("is-invalid");
        }
    });
</script>
{% endblock %}